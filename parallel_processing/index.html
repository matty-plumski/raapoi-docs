<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Parallel Processing - Raapoi Cluster Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  <link href="../extra.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Parallel Processing";
    var mkdocs_page_input_path = "parallel_processing.md";
    var mkdocs_page_url = "/raapoi-docs/parallel_processing/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Raapoi Cluster Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Overview</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Documentation</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../accessing_the_cluster/">Accessing the Cluster</a>
                </li>
                <li class="">
                    
    <a class="" href="../basic_commands/">Basic Commands</a>
                </li>
                <li class="">
                    
    <a class="" href="../storage/">Storage and Quotas</a>
                </li>
                <li class="">
                    
    <a class="" href="../partitions/">Using Paritions</a>
                </li>
                <li class="">
                    
    <a class="" href="../environment/">Preparing your Environment</a>
                </li>
                <li class="">
                    
    <a class="" href="../running_jobs/">Running Jobs</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Parallel Processing</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#parallel-processing">Parallel processing</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#job-array-example">Job Array Example</a></li>
        
            <li><a class="toctree-l4" href="#multi-threaded-or-multi-processing-job-example">Multi-threaded or Multi-processing Job Example</a></li>
        
            <li><a class="toctree-l4" href="#mpi-jobs">MPI Jobs</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../managing_jobs/">Managing Jobs</a>
                </li>
                <li class="">
                    
    <a class="" href="../cloud_providers/">Connecting to Cloud Providers</a>
                </li>
                <li class="">
                    
    <a class="" href="../containers/">Using Containers</a>
                </li>
                <li class="">
                    
    <a class="" href="../notebooks/">Using Jupyter Notebooks</a>
                </li>
                <li class="">
                    
    <a class="" href="../examples/">Examples</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../support/">Support</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../ganglia/">Utilisation</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Raapoi Cluster Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>Documentation &raquo;</li>
        
      
    
    <li>Parallel Processing</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="parallel-processing">Parallel processing<a class="headerlink" href="#parallel-processing" title="Permanent link">&para;</a></h1>
<p>Running a job in parallel is a great way to utilize the power of the cluster.  So what is a parallel job/workflow?</p>
<ul>
<li>Loosely-coupled jobs (sometimes referred to as embarrassingly or naively parallel jobs) are processes in which multiple instances of the same program execute on multiple data files simultaneously, with each instance running independently from others on its own allocated resources (i.e. CPUs and memory). Slurm job arrays offer a simple mechanism for achieving this.</li>
<li>Multi-threaded programs that include explicit support for shared memory processing via multiple threads of execution (e.g. Posix Threads or OpenMP) running across multiple CPU cores.</li>
<li>Distributed memory programs that include explicit support for message passing between processes (e.g. MPI). These processes execute across multiple CPU cores and/or nodes, these are often referred to as tightly-coupled jobs.</li>
<li>GPU (graphics processing unit) programs including explicit support for offloading to the device via languages like CUDA or OpenCL.</li>
</ul>
<p>It is important to understand the capabilities and limitations of an application in order to fully leverage the parallel processing options available on the cluster. For instance, many popular scientific computing languages like Python, R, and Matlab now offer packages that allow for GPU, multi-core or multithreaded processing, especially for matrix and vector operations</p>
<h2 id="job-array-example">Job Array Example<a class="headerlink" href="#job-array-example" title="Permanent link">&para;</a></h2>
<p>Here is an example of running a job array to run 50 simultaneous processes:</p>
<p><code>sbatch array.sh</code></p>
<p>The contents of the array.sh batch script looks like this:</p>
<pre><code>  #!/bin/bash
  #SBATCH -a 1-50
  #SBATCH --cpus-per-task=1
  #SBATCH --mem-per-cpu=2G
  #SBATCH --time=00:10:00
  #SBATCH --partition=parallel
  #SBATCH --mail-type=BEGIN,END,FAIL
  #SBATCH --mail-user=me@email.com

  module load fastqc/0.11.7

  fastqc --nano -o $TMPDIR/output_dir seqfile_${SLURM_ARRAY_TASK_ID}

</code></pre>

<p>So what do these parameter mean?:</p>
<ul>
<li><em>-a</em> sets this up as a parallel array job (this sets up the "loop" that will be run</li>
<li><em>--cpus-per-task</em> requests the number of CPUs per array task, in this case I just want one CPU per task, we will use 50 in total</li>
<li><em>--mem-per-cpu</em> request 2GB of RAM per CPU, for this parallel job I will request a total of 100GB RAM (50 CPUs * 2GB RAM)</li>
<li><em>--time</em> is the max run time for this job, 10 minutes in this case</li>
<li><em>--partition</em> assigns this job to a partition</li>
<li><em>module load fastqc/0.11.7</em>: Load software into my environment, in this case fastqc</li>
<li><em>fastqc --nano -o $TMPDIR/output_dir seqfile</em>${SLURM_ARRAY_TASK_ID}_ Run fastqc on each input data file with the filenames seqfile_1, seqfile_2...seqfile_50</li>
</ul>
<p>Running the array.sh script will cause the SLURM manager to spawn 50 parallel jobs.</p>
<h2 id="multi-threaded-or-multi-processing-job-example">Multi-threaded or Multi-processing Job Example<a class="headerlink" href="#multi-threaded-or-multi-processing-job-example" title="Permanent link">&para;</a></h2>
<p>Multi-threaded or multi-processing programs are applications that are able to
execute in parallel across multiple CPU cores within a single node using a
shared memory execution model. In general, a multi-threaded application uses a
single process (aka “task” in Slurm) which then spawns multiple threads of
execution. By default, Slurm allocates 1 CPU core per task. In order to make use
of multiple CPU cores in a multi-threaded program, one must include the
--cpus-per-task option.  Below is an example of a multi-threaded program
requesting 12 CPU cores per task and a total of 256GB of memory. The program itself is responsible for spawning the appropriate number of threads.</p>
<pre><code>  #!/bin/bash
  #SBATCH --nodes=1
  #SBATCH --ntasks=1
  #SBATCH --cpus-per-task=12 # 12 threads per task
  #SBATCH --time=02:00:00 # two hours
  #SBATCH --mem=256G
  #SBATCH -p bigmem
  #SBATCH --output=threaded.out
  #SBATCH --job-name=threaded
  #SBATCH --mail-type=BEGIN,END,FAIL
  #SBATCH --mail-user=me@email.com
  # Run multi-threaded application
  module load java/1.8.0-91
  java -jar threaded-app.jar
</code></pre>

<h2 id="mpi-jobs">MPI Jobs<a class="headerlink" href="#mpi-jobs" title="Permanent link">&para;</a></h2>
<p>Most users do not require MPI to run their jobs but many do.  Please read on if you want to learn more about using MPI for tightly-coupled jobs.</p>
<p>MPI (Message Passing Interface) code require special attention within Slurm. Slurm allocates and launches MPI jobs differently depending on the version of MPI used (e.g. OpenMPI, MPICH2). We recommend using OpenMPI version 2.1.1 or later to compile your C code (using mpicc) and then using the mpirun command in a batch submit script to launch parallel MPI jobs. The example below runs MPI code compiled by OpenMPI 2.1.1:</p>
<pre><code>  #!/bin/bash
  #SBATCH --nodes=3
  #SBATCH --tasks-per-node=8 # 8 MPI processes per node
  #SBATCH --time=3-00:00:00
  #SBATCH --mem=4G # 4 GB RAM per node
  #SBATCH --output=mpi_job.log
  #SBATCH -p parallel
  #SBATCH --mail-type=BEGIN,END,FAIL
  #SBATCH --mail-user=me@email.com

  module load openmpi
  echo $SLURM_JOB_NODELIST
  mpirun -np 24 mpiscript.o

</code></pre>

<p>This example requests 3 nodes and 8 tasks (i.e. processes) per node, for a total of 24 tasks.  I use this number to tell mpirun how many processes to start, -np 24</p>
<p>NOTE:  If using python or another language you will also need to add the --oversubscribe parameter to mpirun, eg.</p>
<p><code>mpirun --oversubscribe -np 24 mpiscript.py</code></p>
<p>More information about running MPI jobs within Slurm can be found here here: http://slurm.schedmd.com/mpi_guide.html.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../managing_jobs/" class="btn btn-neutral float-right" title="Managing Jobs">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../running_jobs/" class="btn btn-neutral" title="Running Jobs"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../running_jobs/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../managing_jobs/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
